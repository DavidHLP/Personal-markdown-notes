# HBase逻辑模型与物理模型详解

## 一、HBase逻辑模型

> 逻辑模型顺序：表（Table） -> 行（Row） -> 行键(Row Key) -> 列族 (Column Family) -> 列 (Column) -> 单元格 (Cell) <- 时间戳 (Timestamp)

### 1. 表（Table）

- HBase 中的数据以表的形式存储。每个表由多个行组成 ，即数据行的集合，但表结构简单，仅需定义表名和列族。
- 表（Table）特点：
    1. 稀疏性：未使用的列不会占用存储空间
    2. 可伸缩性：通过分区的方式存储和管理数据，可以水平扩展来支持数十亿行和数百列的数据。
    3. 高效的随机访问：行键索引和分布式存储机制使得 HBase 在大规模数据中仍然能支持高效的随机访问。
        -  高效的随机访问并不是一直有效的,这个和RowKey的设计有关，如果RowKey是无序且没有意义的，这会导致Get无法通过RowKey去获取到对应的数据，高效的随机访问在此时便不成立了
    4. 列式存储：在物理模型中Table最终会被列切分为Store存储

### 2. 行（Row）

- 行是 HBase 中的一个逻辑数据单元，它由一个行键和多个列族组成。
- 行特点：
    - **稀疏性**：行之间可以没有固定的列，即不同行可以拥有不同的列，HBase 会自动忽略空的单元格。
    - **多版本控制**：行中的每个列都可以存储多个版本的数据，通过时间戳来标识。默认情况下，HBase 会保留最新的 3 个版本。
    - **高效随机访问**：由于行键的排序和唯一性，HBase 可以高效地定位到特定的行，从而实现快速的随机读取和写入。
- 行结构：
    - 表达一：行键 + 列族（Column Family） + 列限定符（Column Qualifier） + 时间戳（Timestamp） + 类型
    - 表达二：多个Cell（单元格）组成的集合

### 3. 行键(Row Key)

- 行键是 HBase 中每行数据的唯一标识符，相当于关系数据库中的主键。
    - 在物理底层Row Key无法唯一标识一行数据 ， 列限定符有一个version ， 即一个Row Key下的数据其实是有多个版本的 ，Hbase默认获取时间戳最大的 ， 真正能唯一标识的应该是Row Key + Timestamp

- 行键特点：
    - **唯一性**：每个行键在一个表中是唯一的。通过行键可以唯一标识和定位行数据。
    - **排序性**：HBase 表的行按行键的字典顺序排序存储，这意味着行键的设计会直接影响数据的物理存储位置。可以利用这一特性，通过行键的设计来提高查询性能。
    - **不可更改**：在 HBase 中，一旦行键设置好，就不能更改或删除它。HBase 是追加写入的系统，因此删除行键只能通过标记删除来实现，数据仍然保留在底层，直到系统进行垃圾回收。

### 4. 列族 (Column Family)

- 列族是HBase表中的列的逻辑分组，是物理存储的基本单位。每个表至少有一个列族，列族必须在表创建时定义。
- 列族特点：
    - **物理隔离**：不同列族的数据在物理上分开存储，每个列族对应一个HFile文件集合。
    - **共同属性**：同一列族内的所有列共享相同的配置属性，如压缩方式、数据存储时长等。
    - **数量限制**：一般建议每个表的列族数量保持在3个以内，过多的列族会影响性能。
    - **命名规范**：列族名通常使用可打印字符组成，避免使用过长名称，因为列族名会被频繁写入HFile。

### 5. 列 (Column)

- 列是HBase中存储数据的最小逻辑单位，由列族和列限定符(Column Qualifier)组成。
- 列特点：
    - **动态性**：HBase的列是动态的，可以在任何时候添加新列，不需要预先定义表结构。
    - **格式表示**：列的完整表示为"列族:列限定符"，例如"family:qualifier"。
    - **灵活性**：每一行可以有不同的列，同一表中不同行的列数量可以不同。
    - **无类型**：HBase的列没有数据类型的概念，所有值都以字节数组形式存储。

### 6. 单元格 (Cell)

- 单元格是HBase数据存储的最小单位，由{行键, 列族, 列限定符, 时间戳, 类型}五元组唯一确定。
- 单元格特点：
    - **版本化**：每个单元格可以包含同一数据的多个版本，通过时间戳区分。
    - **原子性**：HBase操作的原子性以单元格为单位，确保数据一致性。
    - **存储结构**：单元格中存储的值(Value)是未解释的字节数组，由应用层负责解释。
    - **TTL(Time To Live)**：可以为单元格设置生存时间，超过时间后将被自动清除。

### 7. 时间戳 (Timestamp)

- 时间戳是HBase实现数据多版本的关键机制，用于标识数据的不同版本。
- 时间戳特点：
    - **自动生成**：默认情况下，时间戳由HBase自动生成，使用写入时的系统时间。
    - **用户自定义**：客户端也可以在写入数据时指定时间戳。
    - **版本控制**：通过时间戳，HBase可以保存数据的多个版本，默认保留最新的3个版本。
    - **查询机制**：查询时可以指定时间戳或时间范围，获取特定版本的数据。

## 二、HBase物理模型

> 物理模型顺序：Region -> Store -> MemStore/StoreFile(HFile) -> Block -> KeyValue

### 1. Region

- Region是HBase表数据的物理分片，每个Region包含表中某个行键范围内的所有数据。
- Region特点：
    - **分布式存储**：每个Region被分配到一个RegionServer上进行管理和服务。
    - **自动分裂**：当Region大小超过配置阈值时，会自动分裂为两个子Region。
    - **负载均衡**：通过Region的分裂和迁移，HBase能够实现集群的负载均衡。
    - **结构组成**：每个Region包含表中一个或多个列族的数据，每个列族对应一个Store。

### 2. Store

- Store是Region的物理存储单元，每个Region中的每个列族对应一个Store。
- Store特点：
    - **对应关系**：一个Store对应一个列族的数据。
    - **结构组成**：每个Store包含一个MemStore和零到多个StoreFile(HFile)。
    - **写入路径**：数据先写入MemStore，当MemStore满后，数据被刷新到StoreFile中。

### 3. MemStore

- MemStore是内存中的写缓冲区，新写入的数据首先存储在这里。
- MemStore特点：
    - **排序存储**：MemStore中的数据按照行键有序存储。
    - **刷新机制**：当MemStore达到配置的阈值时，会触发刷新操作，将数据写入新的StoreFile。
    - **性能优化**：MemStore提高了写入性能，避免每次写操作都直接写入磁盘。

### 4. StoreFile(HFile)

- StoreFile是HBase数据在HDFS上的物理存储文件，是对HFile的封装。
- StoreFile特点：
    - **不可变性**：一旦创建，StoreFile内容不可修改，新的更新会创建新的StoreFile。
    - **合并机制**：通过Major和Minor Compaction合并小文件，提高读取效率。
    - **文件结构**：包含数据块、索引块、元数据块等多种块结构。

### 5. Block

- Block是HFile的基本存储单位，HFile由多个Block组成。
- Block特点：
    - **大小可配置**：Block大小默认为64KB，可以根据需要调整。
    - **类型多样**：包括数据Block、索引Block、元数据Block、布隆过滤器Block等。
    - **缓存机制**：Block是HBase缓存的基本单位，频繁访问的Block会被缓存在BlockCache中。

### 6. KeyValue

- KeyValue是HBase存储的最小物理单元，对应于逻辑模型中的一个单元格。
- KeyValue结构：
    - **行键(RowKey)**：标识这个KeyValue属于哪一行。
    - **列族(Family)**：标识列族名称。
    - **列限定符(Qualifier)**：标识具体的列。
    - **时间戳(Timestamp)**：标识数据版本。
    - **类型(Type)**：标识操作类型，如Put、Delete等。
    - **值(Value)**：实际存储的数据内容。

## 三、逻辑模型与物理模型的映射关系

1. **表(Table)到Region的映射**：
   - 一个表被水平划分为多个Region，每个Region负责表中一段连续的行键范围。

2. **列族(Column Family)到Store的映射**：
   - 每个列族在物理上对应一个Store，Store是Region中的物理存储单元。

3. **行(Row)到KeyValue序列的映射**：
   - 一行数据在物理上被拆分为多个KeyValue，每个KeyValue对应逻辑模型中的一个单元格。

4. **单元格(Cell)到KeyValue的映射**：
   - 逻辑模型中的单元格在物理模型中对应一个KeyValue结构。

5. **存储过程映射**：
   - 数据写入时：Client → Region → Store → MemStore → (Flush) → StoreFile → HFile
   - 数据读取时：HFile → StoreFile → BlockCache(可选) → Client
