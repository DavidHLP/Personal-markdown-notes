---
title: Redis持久化
published: 2025-06-09
tags: [Redis, Java]
category: Redis
description: Redis持久化机制深度解析：RDB和AOF两种持久化方式的原理、配置、优缺点对比及最佳实践。了解如何通过持久化机制确保Redis数据安全，防止数据丢失，以及如何根据业务场景选择合适的持久化策略。
draft: false
---
# Redis 持久化

Redis 提供了两种持久化方案来确保数据安全：RDB（Redis Database Backup）和 AOF（Append Only File）。这两种机制可以单独使用，也可以结合使用，以满足不同场景下的数据持久化需求。

## 1. RDB 持久化

RDB（Redis Database Backup）是 Redis 的默认持久化方式，通过创建数据快照来实现持久化。其核心思想是在指定时间间隔内，将内存中的数据集以二进制格式写入磁盘，生成一个名为 dump.rdb 的压缩文件。当 Redis 服务重启时，可以通过加载 RDB 文件快速恢复数据。RDB 文件默认保存在 Redis 服务器的当前工作目录下。

### 1.1 执行时机

RDB 持久化主要在以下四种场景下触发：

1. 手动执行 save 命令：该命令会阻塞 Redis 服务器进程，直到 RDB 文件创建完毕。由于会阻塞其他命令执行，通常不推荐在生产环境使用。
2. 执行 bgsave 命令：该命令会 fork 一个子进程来创建 RDB 文件，主进程继续处理命令请求，这是推荐的 RDB 持久化方式。
3. Redis 正常关闭时：如果配置了 save 选项，Redis 在关闭前会执行一次 RDB 持久化。
4. 满足自动保存条件时：当在指定时间间隔内发生指定次数的写操作时，会自动触发 bgsave。

#### 1.1.1 save 命令

通过执行 `save`命令可以立即触发 RDB 持久化，但这种方式会阻塞 Redis 主线程，导致服务不可用。因此，在生产环境中应谨慎使用，通常仅用于数据迁移等特殊场景。

#### 1.1.2 bgsave 命令

`bgsave`命令是 `save`的异步版本，执行该命令后，Redis 会 fork 一个子进程来完成 RDB 文件的写入工作，主进程继续处理客户端请求。这是推荐的 RDB 持久化方式。

#### 1.1.3 停机时持久化

当 Redis 正常关闭时，如果配置了 save 选项，Redis 会在关闭前自动执行一次 RDB 持久化，确保数据不会丢失。

#### 1.1.4 自动触发机制

Redis 支持通过配置文件设置自动触发 RDB 持久化的条件，配置格式如下：

```properties
# 在900秒内如果至少有1个key发生变化，则执行bgsave
save 900 1
# 在300秒内如果至少有10个key发生变化，则执行bgsave
save 300 10
# 在60秒内如果至少有10000个key发生变化，则执行bgsave
save 60 10000
# 如果不需要RDB持久化，可以设置为 save ""
```

除了触发条件外，RDB 还支持以下重要配置：

```properties
# 是否对RDB文件进行LZF压缩，默认yes
# 压缩会减少磁盘空间占用，但会增加CPU消耗
rdbcompression yes

# 指定RDB文件名，默认为dump.rdb
dbfilename dump.rdb

# 指定RDB文件保存目录，默认为Redis启动目录
dir ./
```

### 1.2 实现原理

RDB 持久化的核心在于 `bgsave`命令的执行过程，该过程主要包含以下步骤：

1. Redis 主进程 fork 一个子进程，子进程与父进程共享相同的内存空间。
2. 子进程将内存中的数据写入临时 RDB 文件。
3. 写入完成后，用新的 RDB 文件原子替换旧的 RDB 文件。

为了提高性能，Redis 采用了写时复制（Copy-on-Write）技术：

- 在子进程创建时，父子进程共享相同的内存页。
- 当父进程需要修改某个内存页时，会先复制该页，然后在副本上进行修改。
- 这种方式避免了不必要的内存拷贝，提高了性能。

![RDB持久化原理](images/Redis持久化/image-20210725151319695.png)

### 1.3 优缺点分析

#### 执行流程

RDB 持久化的核心流程包括三个步骤：首先 fork 出子进程并与父进程共享内存空间；然后子进程将内存数据写入临时 RDB 文件；最后用新生成的 RDB 文件原子替换旧文件。

#### 触发条件

RDB 持久化主要在以下情况触发：

- 手动执行 `save`或 `bgsave`命令
- 达到配置的自动保存条件（如 `save 60 1000`表示 60 秒内发生 1000 次写操作）
- Redis 正常关闭时

#### 优势

- 性能优秀：生成 RDB 文件时，主进程继续处理命令，只有 fork 时会短暂阻塞
- 恢复速度快：RDB 文件是紧凑的二进制文件，加载速度快
- 适合备份：RDB 文件适合用于备份和灾难恢复

#### 劣势

- 数据安全性较低：可能丢失最后一次 RDB 之后的数据
- 大数据量时 fork 过程可能阻塞服务
- RDB 文件是完整的数据集，不适合实时备份

## 2. AOF 持久化

### 2.1 核心原理

AOF（Append Only File）是 Redis 提供的另一种持久化方式，它以日志的形式记录每个写操作命令，并在 Redis 重启时通过重新执行这些命令来恢复数据。与 RDB 的定时快照不同，AOF 提供了更好的持久性保证。

AOF 的工作流程如下：

1. 客户端发送写命令到 Redis 服务器
2. 服务器执行命令并将命令追加到 AOF 缓冲区
3. 根据配置的同步策略，将缓冲区内容写入 AOF 文件
4. 定期对 AOF 文件进行重写以压缩文件体积

![AOF持久化流程](images/Redis持久化/image-20210725151543640.png)

### 2.2 配置详解

AOF 持久化默认是关闭的，需要在 redis.conf 中进行如下配置：

```properties
# 开启AOF持久化
appendonly yes
# 指定AOF文件名，默认为appendonly.aof
appendfilename "appendonly.aof"
```

AOF 的同步策略通过 `appendfsync`参数控制，它决定了数据写入 AOF 文件的时机：

```properties
# 每次写操作都会立即同步到磁盘，数据最安全但性能最差
appendfsync always

# 每秒同步一次，是性能和数据安全的折中方案（默认值）
appendfsync everysec

# 由操作系统决定同步时机，性能最好但数据安全性最低
appendfsync no
```

三种同步策略对比如下：

| 策略     | 同步时机   | 数据安全性 | 性能 | 适用场景                   |
| -------- | ---------- | ---------- | ---- | -------------------------- |
| always   | 每次写操作 | 最高       | 最差 | 对数据安全性要求极高的场景 |
| everysec | 每秒一次   | 较高       | 较好 | 通用场景（默认）           |
| no       | 由系统决定 | 最低       | 最好 | 可以容忍数据丢失的场景     |

![AOF同步策略对比](images/Redis持久化/image-20210725151654046.png)

### 2.3 AOF 重写机制

由于 AOF 文件记录的是所有写命令，随着时间推移，文件体积会不断增大。同时，对于同一个 key 的多次操作，只有最后一次操作是有效的。为了解决这些问题，Redis 提供了 AOF 重写机制。

#### 重写原理

AOF 重写并不是简单地对现有 AOF 文件进行压缩，而是通过读取当前数据库状态，生成一个新的 AOF 文件，该文件包含了重建当前数据集所需的最少命令集。例如：

```
# 重写前
set name jack
set age 30
set name tom
set age 31

# 重写后
set name tom
set age 31
```

#### 触发方式

AOF 重写可以通过以下两种方式触发：

1. 手动触发：执行 `BGREWRITEAOF`命令
2. 自动触发：当 AOF 文件大小同时满足以下两个条件时：
   - 当前 AOF 文件大小 > `auto-aof-rewrite-min-size`
   - 当前 AOF 文件大小比上一次重写后的大小增长超过 `auto-aof-rewrite-percentage`%

#### 相关配置

```properties
# AOF文件大小比上次重写后的大小增长超过100%时触发重写
auto-aof-rewrite-percentage 100
# AOF文件体积达到64MB以上时才可能触发重写
auto-aof-rewrite-min-size 64mb
```

![AOF重写过程](images/Redis持久化/image-20210725151729118.png)

## 3. RDB 与 AOF 对比与选择

RDB 和 AOF 是 Redis 提供的两种不同的持久化机制，它们各有优缺点，适用于不同的场景。

### 3.1 核心区别

| 特性       | RDB                                  | AOF                          |
| ---------- | ------------------------------------ | ---------------------------- |
| 持久化方式 | 定时快照                             | 记录写命令                   |
| 数据完整性 | 可能丢失最后一次快照后的数据         | 根据配置可以做到最少数据丢失 |
| 恢复速度   | 较快                                 | 较慢                         |
| 文件体积   | 较小                                 | 较大                         |
| 对性能影响 | 保存时 fork 子进程，可能导致短暂阻塞 | 根据配置不同，影响从低到高   |
| 适用场景   | 适合数据备份和灾难恢复               | 适合对数据安全性要求高的场景 |

### 3.2 生产环境建议

1. **混合使用**：同时开启 RDB 和 AOF，利用 RDB 进行快速恢复，AOF 确保数据安全。
2. **AOF 配置**：使用 `appendfsync everysec`，在性能和数据安全间取得平衡。
3. **监控机制**：监控 AOF 文件大小，合理设置重写策略。
4. **备份策略**：定期备份 RDB 文件到其他服务器。

![RDB与AOF对比](images/Redis持久化/image-20210725151940515.png)

### 3.3 总结

- **RDB**：适合做冷备，恢复速度快，但可能丢失数据。
- **AOF**：数据安全性高，但文件较大，恢复较慢。
- **最佳实践**：生产环境建议同时开启 RDB 和 AOF，通过 `aof-use-rdb-preamble`（Redis 4.0+）结合两者的优势。
